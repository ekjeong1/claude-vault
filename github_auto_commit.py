#!/usr/bin/env python3
"""
GitHub Auto-commit for Obsidian RSI
ë³€ê²½ì‚¬í•­ ìë™ ê°ì§€ ë° ì»¤ë°‹/í‘¸ì‹œ
"""

import subprocess
from pathlib import Path
from datetime import datetime
import sys

def run_git_command(command, cwd):
    """
    Git ëª…ë ¹ ì‹¤í–‰
    """
    try:
        result = subprocess.run(
            command,
            cwd=cwd,
            capture_output=True,
            text=True,
            check=True
        )
        return True, result.stdout.strip()
    except subprocess.CalledProcessError as e:
        return False, e.stderr.strip()


def check_git_status(vault_path):
    """
    Git ìƒíƒœ í™•ì¸
    """
    success, output = run_git_command(['git', 'status', '--porcelain'], vault_path)
    
    if not success:
        return None, "Git repository not initialized or error occurred"
    
    if not output:
        return [], "No changes detected"
    
    # ë³€ê²½ íŒŒì¼ ëª©ë¡
    changes = []
    for line in output.split('\n'):
        if line.strip():
            status = line[:2].strip()
            file_path = line[3:].strip()
            changes.append({
                'status': status,
                'file': file_path
            })
    
    return changes, None


def categorize_changes(changes):
    """
    ë³€ê²½ì‚¬í•­ ì¹´í…Œê³ ë¦¬í™”
    """
    categories = {
        'added': [],
        'modified': [],
        'deleted': [],
        'renamed': []
    }
    
    for change in changes:
        status = change['status']
        file_path = change['file']
        
        if status in ['A', '??']:
            categories['added'].append(file_path)
        elif status == 'M':
            categories['modified'].append(file_path)
        elif status == 'D':
            categories['deleted'].append(file_path)
        elif status == 'R':
            categories['renamed'].append(file_path)
    
    return categories


def generate_commit_message(categories):
    """
    ìë™ ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
    """
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M')
    
    # ë³€ê²½ ìš”ì•½
    summary_parts = []
    
    if categories['added']:
        summary_parts.append(f"Add {len(categories['added'])} file(s)")
    if categories['modified']:
        summary_parts.append(f"Update {len(categories['modified'])} file(s)")
    if categories['deleted']:
        summary_parts.append(f"Delete {len(categories['deleted'])} file(s)")
    if categories['renamed']:
        summary_parts.append(f"Rename {len(categories['renamed'])} file(s)")
    
    summary = ", ".join(summary_parts)
    
    # ìƒì„¸ ë©”ì‹œì§€ êµ¬ì„±
    message = f"[Auto RSI] {summary}\n\nTimestamp: {timestamp}\n"
    
    # íŒŒì¼ë³„ ìƒì„¸
    if categories['added']:
        message += f"\nAdded:\n"
        for f in categories['added'][:5]:  # ìµœëŒ€ 5ê°œ
            message += f"  - {f}\n"
        if len(categories['added']) > 5:
            message += f"  ... and {len(categories['added'])-5} more\n"
    
    if categories['modified']:
        message += f"\nModified:\n"
        for f in categories['modified'][:5]:
            message += f"  - {f}\n"
        if len(categories['modified']) > 5:
            message += f"  ... and {len(categories['modified'])-5} more\n"
    
    if categories['deleted']:
        message += f"\nDeleted:\n"
        for f in categories['deleted'][:5]:
            message += f"  - {f}\n"
        if len(categories['deleted']) > 5:
            message += f"  ... and {len(categories['deleted'])-5} more\n"
    
    message += "\n---\nGenerated by Auto RSI GitHub Auto-commit"
    
    return message


def git_add_all(vault_path):
    """
    ëª¨ë“  ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§•
    """
    success, output = run_git_command(['git', 'add', '.'], vault_path)
    return success, output


def git_commit(vault_path, message):
    """
    ì»¤ë°‹ ì‹¤í–‰
    """
    success, output = run_git_command(['git', 'commit', '-m', message], vault_path)
    return success, output


def git_push(vault_path, remote='origin', branch='main'):
    """
    í‘¸ì‹œ ì‹¤í–‰
    """
    success, output = run_git_command(['git', 'push', remote, branch], vault_path)
    return success, output


def main():
    """
    ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜
    """
    print("="*60)
    print("GitHub Auto-commit for Obsidian RSI")
    print("="*60)
    
    # Vault ê²½ë¡œ ì„¤ì • (ìˆ˜ì • í•„ìš”)
    vault_path = Path(r"C:\Users\win10_original\claude-vault")
    
    if not vault_path.exists():
        print(f"âŒ Error: Vault not found at {vault_path}")
        print("Please update vault_path in the script.")
        return
    
    print(f"\nğŸ“‚ Vault: {vault_path}")
    
    # Git ì €ì¥ì†Œ í™•ì¸
    git_dir = vault_path / ".git"
    if not git_dir.exists():
        print("âŒ Error: Not a git repository")
        print("Please initialize git repository first:")
        print(f"  cd {vault_path}")
        print("  git init")
        return
    
    # ë³€ê²½ì‚¬í•­ í™•ì¸
    print("\nğŸ” Checking for changes...")
    changes, error = check_git_status(vault_path)
    
    if error:
        print(f"â„¹ï¸ {error}")
        return
    
    if not changes:
        print("âœ“ No changes to commit")
        return
    
    print(f"âœ“ Found {len(changes)} changed file(s)")
    
    # ë³€ê²½ì‚¬í•­ ì¹´í…Œê³ ë¦¬í™”
    categories = categorize_changes(changes)
    
    print("\nğŸ“Š Changes summary:")
    if categories['added']:
        print(f"  â• Added: {len(categories['added'])} file(s)")
    if categories['modified']:
        print(f"  âœï¸ Modified: {len(categories['modified'])} file(s)")
    if categories['deleted']:
        print(f"  âŒ Deleted: {len(categories['deleted'])} file(s)")
    if categories['renamed']:
        print(f"  ğŸ”„ Renamed: {len(categories['renamed'])} file(s)")
    
    # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
    commit_message = generate_commit_message(categories)
    
    print("\nğŸ“ Commit message:")
    print("-" * 60)
    print(commit_message)
    print("-" * 60)
    
    # ì‚¬ìš©ì í™•ì¸ (ìë™ ëª¨ë“œë©´ ìŠ¤í‚µ)
    if '--auto' not in sys.argv:
        response = input("\nProceed with commit? (y/n): ")
        if response.lower() != 'y':
            print("âŒ Commit cancelled")
            return
    
    # Git add
    print("\nğŸ“¦ Staging changes...")
    success, output = git_add_all(vault_path)
    
    if not success:
        print(f"âŒ Error staging changes: {output}")
        return
    
    print("âœ“ Changes staged")
    
    # Git commit
    print("\nğŸ’¾ Committing...")
    success, output = git_commit(vault_path, commit_message)
    
    if not success:
        print(f"âŒ Error committing: {output}")
        return
    
    print("âœ“ Changes committed")
    
    # Git push (ì„ íƒì )
    if '--push' in sys.argv or '--auto' in sys.argv:
        print("\nğŸ“¤ Pushing to remote...")
        
        # ë¸Œëœì¹˜ í™•ì¸
        success, current_branch = run_git_command(['git', 'branch', '--show-current'], vault_path)
        
        if not success:
            print(f"âš ï¸ Could not determine current branch, using 'main'")
            current_branch = 'main'
        
        success, output = git_push(vault_path, 'origin', current_branch)
        
        if not success:
            print(f"âš ï¸ Push failed: {output}")
            print("You may need to push manually")
        else:
            print("âœ“ Changes pushed to remote")
    else:
        print("\nâ„¹ï¸ Changes committed locally (not pushed)")
        print("Use --push flag to push automatically")
    
    print("\n" + "="*60)
    print("âœ¨ Auto-commit completed!")
    print("="*60)


if __name__ == "__main__":
    """
    ì‚¬ìš©ë²•:
    
    1. ê¸°ë³¸ ì‹¤í–‰ (í™•ì¸ í›„ ì»¤ë°‹):
       python github_auto_commit.py
    
    2. ìë™ ì»¤ë°‹ (í™•ì¸ ì—†ì´):
       python github_auto_commit.py --auto
    
    3. ì»¤ë°‹ + í‘¸ì‹œ:
       python github_auto_commit.py --push
    
    4. ì™„ì „ ìë™ (ì»¤ë°‹ + í‘¸ì‹œ):
       python github_auto_commit.py --auto --push
    """
    main()
